<section id="partners-marquee-{{ section.id }}" class="relative w-full bg-white py-12 md:py-20 overflow-x-clip">
  <div class="max-w-full mx-auto px-4 md:px-8 flex flex-col items-center">

    {% if section.settings.label %}
      <div class="mb-2 tracking-[0.22em] uppercase text-xs font-bold text-[#A68B61] text-center">
        {{ section.settings.label }}
      </div>
    {% endif %}

    {% if section.settings.heading %}
      <h2 class="mb-8 text-3xl md:text-4xl lg:text-5xl font-extrabold text-black text-center" style="{% if section.settings.heading_shadow %}text-shadow:0 2px 16px #eee;{% endif %}">
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <!-- Marquee Row 1 (left to right) -->
    <div class="w-full overflow-hidden relative mb-6">
      <div
        class="marquee-track flex gap-6 md:gap-8 items-center"
        data-marquee-direction="ltr"
        data-marquee-speed="{{ section.settings.marquee_speed | default: 32 }}"
        style="will-change: transform">
        {% for block in section.blocks %}
          <div class="flex-none w-[200px] h-[110px] md:w-[255px] md:h-[130px] rounded-xl bg-[#3F5D4A] flex items-center justify-center transition-transform duration-300 ease-in-out hover:scale-105">
            {% if block.settings.logo %}
              <img
                height=""
                width=""
                src="{{ block.settings.logo | img_url: '240x120' }}"
                srcset="
                  {{ block.settings.logo | img_url: '120x60' }} 120w,
                  {{ block.settings.logo | img_url: '180x90' }} 180w,
                  {{ block.settings.logo | img_url: '240x120' }} 240w
                "
                sizes="(max-width: 640px) 122px, 180px"
                alt="{{ block.settings.logo_alt | escape }}"
                class="max-h-[48px] md:max-h-[65px] max-w-[140px] object-contain mx-auto"
                loading="lazy">
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Marquee Row 2 (right to left) -->
    <div class="w-full overflow-hidden relative">
      <div
        class="marquee-track flex gap-6 md:gap-8 items-center"
        data-marquee-direction="rtl"
        data-marquee-speed="{{ section.settings.marquee_speed_2 | default: 36 }}"
        style="will-change: transform">
        {% for block in section.blocks %}
          <div class="flex-none w-[200px] h-[110px] md:w-[255px] md:h-[130px] rounded-xl bg-[#3F5D4A] flex items-center justify-center transition-transform duration-300 ease-in-out hover:scale-105">
            {% if block.settings.logo %}
              <img
                height=""
                width=""
                src="{{ block.settings.logo | img_url: '240x120' }}"
                srcset="
                  {{ block.settings.logo | img_url: '120x60' }} 120w,
                  {{ block.settings.logo | img_url: '180x90' }} 180w,
                  {{ block.settings.logo | img_url: '240x120' }} 240w
                "
                sizes="(max-width: 640px) 122px, 180px"
                alt="{{ block.settings.logo_alt | escape }}"
                class="max-h-[48px] md:max-h-[65px] max-w-[140px] object-contain mx-auto"
                loading="lazy">
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <script>
    // Seamless, robust, bi-directional, gapless marquee (works in all browsers)
    (function() {
      const section = document.getElementById("partners-marquee-{{ section.id }}");
      if (!section) return;
      const tracks = section.querySelectorAll('.marquee-track');
      tracks.forEach(function(track) {
        // Duplicate content for seamlessness
        track.innerHTML += track.innerHTML;
    
        // Wait for all images to load before measuring
        const imgs = track.querySelectorAll('img');
        let loaded = 0;
        let measureAndAnimate = function() {
          // Only measure the first half of the children
          let half = track.children.length / 2;
          let totalWidth = 0;
          for (let i=0; i<half; i++) {
            const style = window.getComputedStyle(track.children[i]);
            totalWidth += track.children[i].offsetWidth +
              parseInt(style.marginLeft) + parseInt(style.marginRight);
          }
          // Animation variables
          let dir = track.getAttribute('data-marquee-direction') === 'rtl' ? -1 : 1;
          let speed = Number(track.getAttribute('data-marquee-speed')) || 32;
          let pos = dir === 1 ? -totalWidth : 0;
    
          function step() {
            // 60fps: move by (totalWidth / speed / 60) per frame
            const pxStep = totalWidth / (speed * 60);
            pos += dir * pxStep;
            // Reset as soon as looped
            if (dir === 1 && pos >= 0)          pos = -totalWidth;
            else if (dir === -1 && pos <= -totalWidth) pos = 0;
            track.style.transform = `translateX(${pos}px)`;
            requestAnimationFrame(step);
          }
          step();
    
          // Optional: Pause on hover (uncomment to enable)
          // track.parentNode.addEventListener('mouseenter',()=>track.style.pointerEvents='none');
          // track.parentNode.addEventListener('mouseleave',()=>track.style.pointerEvents='auto');
        };
        if (imgs.length === 0) measureAndAnimate();
        else {
          imgs.forEach(img=>{
            if (img.complete) loaded++;
            img.addEventListener('load', () => {
              loaded++;
              if (loaded === imgs.length) measureAndAnimate();
            });
          });
          // Fallback if all images are cached
          setTimeout(()=>{
            if (loaded === imgs.length) measureAndAnimate();
          }, 900);
        }
      });
    })();
  </script>
</section>

{% schema %}
  {
    "name": "Partners Marquee",
    "settings": [
      {
        "type": "text",
        "id": "label",
        "label": "Top Label",
        "default": "OUR PARTNERS"
      },
      {
        "type": "text",
        "id": "heading",
        "label": "Main Heading",
        "default": "Top Collaborators"
      },
      {
        "type": "checkbox",
        "id": "heading_shadow",
        "label": "Enable Heading Text-Shadow",
        "default": false
      },
      {
        "type": "range",
        "id": "marquee_speed",
        "label": "Top Marquee Loop Speed (seconds, lower = faster)",
        "min": 10,
        "max": 60,
        "step": 1,
        "default": 32
      }, {
        "type": "range",
        "id": "marquee_speed_2",
        "label": "Bottom Marquee Loop Speed (seconds, lower = faster)",
        "min": 10,
        "max": 60,
        "step": 1,
        "default": 36
      }
    ],
    "blocks": [
      {
        "type": "logo",
        "name": "Partner Logo",
        "settings": [
          {
            "type": "text",
            "id": "partner_name",
            "label": "Partner Name",
            "default": "Partner"
          }, {
            "type": "image_picker",
            "id": "logo",
            "label": "Logo"
          }, {
            "type": "text",
            "id": "logo_alt",
            "label": "Logo Alt Text",
            "default": "Partner logo"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Partners Marquee",
        "category": "Media"
      }
    ]
  }
{% endschema %}